suite: StatefulSet
templates:
  - statefulset.yaml
tests:
  - it: propagates custom labels and annotations
    values:
      - ../ci/metadata-values.yaml
    asserts:
      - equal:
          path: metadata.labels.custom/sts-label
          value: sts-value
      - equal:
          path: metadata.annotations.custom/sts-annotation
          value: sts-annotation-value
      - equal:
          path: spec.template.metadata.labels.custom/pod-label
          value: pod-value
      - equal:
          path: spec.template.metadata.annotations.custom/pod-annotation
          value: pod-annotation-value

  - it: renders valueFrom for secret references
    values:
      - ../ci/valuefrom-values.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_secret_key
            valueFrom:
              secretKeyRef:
                name: zulip-secrets
                key: secret-key

  - it: includes sidecar containers
    values:
      - ../ci/sidecar-values.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers
          content:
            name: backup-agent
            image: busybox:latest
            command:
              - sleep
              - infinity

  - it: references existing PVC when configured
    values:
      - ../ci/existing-pvc-values.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          pattern: my-existing-pvc

  - it: sets external service env vars when subcharts are disabled
    values:
      - ../ci/external-services-values.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SETTING_REMOTE_POSTGRES_HOST
            value: pg.example.com
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SETTING_REMOTE_POSTGRES_SSLMODE
            value: require
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SETTING_RABBITMQ_HOST
            value: rabbitmq.example.com
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SETTING_MEMCACHED_LOCATION
            value: "memcached.example.com:11211"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SETTING_REDIS_HOST
            value: redis.example.com

  - it: renders SECRETS_secret_key from zulip.password for backwards compatibility
    values:
      - ../ci/compat-password-values.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_secret_key
            value: compat-secret-key

  - it: uses valueFrom when subchart existingSecret is set
    values:
      - ../ci/existing-secrets-values.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_postgres_password
            valueFrom:
              secretKeyRef:
                name: my-pg-secret
                key: password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_rabbitmq_password
            valueFrom:
              secretKeyRef:
                name: my-rabbitmq-secret
                key: rabbitmq-password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_memcached_password
            valueFrom:
              secretKeyRef:
                name: my-memcached-secret
                key: memcached-password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_redis_password
            valueFrom:
              secretKeyRef:
                name: my-redis-secret
                key: redis-password

  - it: uses valueFrom for external service passwords
    values:
      - ../ci/external-valuefrom-values.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_postgres_password
            valueFrom:
              secretKeyRef:
                name: external-pg-secret
                key: password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_rabbitmq_password
            valueFrom:
              secretKeyRef:
                name: external-rabbitmq-secret
                key: password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_memcached_password
            valueFrom:
              secretKeyRef:
                name: external-memcached-secret
                key: password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SECRETS_redis_password
            valueFrom:
              secretKeyRef:
                name: external-redis-secret
                key: password
